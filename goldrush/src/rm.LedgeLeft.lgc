[***********************************************************[[ rm.LedgeLeft[[ The left side of the Green River hotel. Jerrod can break[ into room 12 as an alternative to going through the secret[ passage in the fireplace. The guest in room 13 can startle[ Jerrod and make him fall off the ledge. [[***********************************************************[ **************************************[ LOCAL DEFINES[ **************************************#define oWindow13                    o1#define oWindow12                    o2#define oRoom13Guest                 o3#define vDX                        v220#define vDY                        v221[ v222 is not used#define vCelNum                    v223#define vGuest13Status             v224  #define GS_OUT_OF_SIGHT       0  [ guest is away from window  #define GS_MOVING_RIGHT       1  [ guest is walking to right, in front of window  #define GS_MOVING_LEFT        2  [ guest is walking to left, in front of window  #define GS_WAVING             3  [ guest is waving at Jerrod  #define GS_JERROD_FALLING     4  [ Jerrod is startled by guest, begins falling  #define GS_DONE_WAVING        5  [ guest stops waving, watches Jerrod continue falling  #define GS_JERROD_FELL        6  [ Jerrod has fallen and is off screen  #define GS_STANDS_UP          7  [ guest stands up after watching Jerrod fall#define vAwayTimer                 v225#define vLoopNum                   v226#define vFallTimer                 v227#define fIsFalling                 f220#define fDoneFalling               f221#define fWindowMoved               f222#define fMusicDone                 f223#define fGuest13Moved              f224#define fSndDone                   f225[ **************************************[ FIRST CYCLE ONLY[ **************************************if (isset(newRoom))  {  [ load picture for current room  load.pic(currentRoom);    [ load views used in the room  load.view(vw.HotelArt);  load.view(vw.LedgeArt);  load.view(vw.RoomWindowArt);    [ load sounds used in the room  load.sound(m.Death);  load.sound(m.LedgeWarning);  load.sound(s.WindowBreak);    [ draw the room picture  draw.pic(currentRoom);    [ add first floor window to background, showing it  [ partially open  add.to.pic(vw.LedgeArt, 3, 3, 117, 148, 8, 8);    [ guest in room 13 walks back and forth in front of the  [ window  animate.obj(oRoom13Guest);  set.view(oRoom13Guest, vw.RoomWindowArt);  set.loop(oRoom13Guest, 0);  set.cel(oRoom13Guest, 0);  set.priority(oRoom13Guest, 9);  position(oRoom13Guest, 48, 79);  draw(oRoom13Guest);  end.of.loop(oRoom13Guest, fGuest13Moved);  [ set status to show guest is walking to right  vGuest13Status = GS_MOVING_RIGHT;    [ room 13 window  animate.obj(oWindow13);  set.view(oWindow13, vw.LedgeArt);  [ window starts fully open (and never changes; this could  [ have been added to picture instead of using a screen  [ object)  set.loop(oWindow13, 3);  set.cel(oWindow13, 4);  set.priority(oWindow13, 8);  ignore.blocks(oWindow13);  ignore.objs(oWindow13);  position(oWindow13, 47, 80);  draw(oWindow13);  stop.update(oWindow13);    [ room 12 window  animate.obj(oWindow12);  set.view(oWindow12, vw.LedgeArt);  [ loop depends on whether or not window is broken  if (isset(Window12Broken))    {    set.loop(oWindow12, 4);    }  else    {    set.loop(oWindow12, 3);    }  [ starting cel depends on whether or not window is open  if (isset(Window12Open))    {    set.cel(oWindow12, 4);    }  else    {    set.cel(oWindow12, 0);    }  set.priority(oWindow12, 8);  ignore.blocks(oWindow12);  ignore.objs(oWindow12);  position(oWindow12, 117, 80);  draw(oWindow12);  stop.update(oWindow12);    [ Jerrod, on the ledge  animate.obj(ego);  set.view(ego, vw.LedgeArt);  set.priority(ego, 10);  egoDir = STOPPED;  draw(ego);    [ show the picture  show.pic();    [ set warning flag so music will begin playing  set(fMusicDone);  }  [ **************************************[ EVERY CYCLE[ **************************************[ if Jerrod is not falling off the ledgeif (!isset(fIsFalling))  {  [ when warning music finishes  if (isset(fMusicDone))    {    [ start it again    sound(m.LedgeWarning, fMusicDone);    }  }  [ if away timer is activeif (vAwayTimer > 0)  {  [ decrement the timer  --vAwayTimer;  }  [ if away timer hits zero and guest is not at the windowif (vAwayTimer == 0 && vGuest13Status == GS_OUT_OF_SIGHT)  {  [ reverse direction by checking current loop and swapping  [ it  current.loop(oRoom13Guest, vLoopNum);  [ if guest last walked to left  if (vLoopNum == 1)    {    [ reset cel    set.cel(oRoom13Guest, 0);    [ switch to walking-right loop    set.loop(oRoom13Guest, 0);    draw(oRoom13Guest);    end.of.loop(oRoom13Guest, fGuest13Moved);    [ guest is walking to right    vGuest13Status = GS_MOVING_RIGHT;    }  [ if guest last walked to right  if (vLoopNum == 0)    {    [ reset cel    set.cel(oRoom13Guest, 0);    [ switch to walking-left loop    set.loop(oRoom13Guest, 1);    draw(oRoom13Guest);    end.of.loop(oRoom13Guest, fGuest13Moved);    [ guest is walking to left    vGuest13Status = GS_MOVING_LEFT;    }  }  [ when guest finishes moving at the windowif (isset(fGuest13Moved))  {  [ reset the flag  reset(fGuest13Moved);    [ (both these 'if' blocks have exact same commands;  [ they could have used a single 'if' block that used an  [ 'or' operator to be more efficient)    [ if currently moving to right  if (vGuest13Status == GS_MOVING_RIGHT)    {    [ remove guest from screen    erase(oRoom13Guest);    vGuest13Status = GS_OUT_OF_SIGHT;    [ choose a random amount of time for guest to be away    [ from the window    random(10, 50, vAwayTimer);    }      [ if currently moving to the left  if (vGuest13Status == GS_MOVING_LEFT)    {    [ remove guest from screen    erase(oRoom13Guest);    vGuest13Status = GS_OUT_OF_SIGHT;    [ choose a random amount of time for guest to be away    [ from the window    random(10, 50, vAwayTimer);    }    [ if guest is waving at Jerrod  if (vGuest13Status == GS_WAVING)    {    [ Jerrod is startled and begins falling    vGuest13Status = GS_JERROD_FALLING;    [ trigger a fall (by setting flag, as if Jerrod walked    [ off the ledge)    set(egoHitSpecial);    }      [ after guest stands back up   if (vGuest13Status == GS_STANDS_UP)    {    [ guest is done; he goes back to walking back and forth        [ reposition so changed loop shows in correct position    vDX = 3;    vDY = 0;    reposition(oRoom13Guest, vDX, vDY);    [ guest starts in middle of window moving to right    set.loop(oRoom13Guest, 0);    set.cel(oRoom13Guest, 4);    end.of.loop(oRoom13Guest, fGuest13Moved);    vGuest13Status = GS_MOVING_RIGHT;    }    [ if Jerrod is now off screen after falling  if (vGuest13Status == GS_JERROD_FELL)    {    [ the guest stands back up    vGuest13Status = GS_STANDS_UP;    end.of.loop(oRoom13Guest, fGuest13Moved);    }  }  [ if Jerrod is in front of window for room 13 and guest is[ moving past or goneif (posn(ego, 38, 94, 54, 96) && vGuest13Status < GS_WAVING)  {  [ get guest's current cel  current.cel(oRoom13Guest, vCelNum);  [ if guest is in view of the window  if (vCelNum > 1 && vCelNum < 7)    {    [ uh oh! Jerrod gets caught - reposition guest at window    [ to confront Jerrod    vDX = -3; [ 253;    vDY = 0;    reposition(oRoom13Guest, vDX, vDY);    [ change to loop showing guest waving at Jerrod    set.loop(oRoom13Guest, 2);    set.cel(oRoom13Guest, 0);    end.of.loop(oRoom13Guest, fGuest13Moved);    [ guest waves at Jerrod, starting the fall sequence    vGuest13Status = GS_WAVING;    }  }  [ while Jerrod is falling off the ledgeif (vGuest13Status == GS_JERROD_FALLING)  {  [ increment fall timer  ++vFallTimer;  [ after 30 cycles  if (vFallTimer == 30)    {    [ reset timer    vFallTimer = 0;    [ the guest stops waving while Jerrod continues to fall    vGuest13Status = GS_DONE_WAVING;    set.loop(oRoom13Guest, 3);    set.cel(oRoom13Guest, 0);    }  }  [ after guest is done wavingif (vGuest13Status == 5)  {  [ increment timer  ++vFallTimer;  [ after 30 cycles  if (vFallTimer == 30)    {    [ reset timer    vFallTimer = 0;    [ Jerrod is done falling    vGuest13Status = GS_JERROD_FELL;    [ guest begins standing back up    end.of.loop(oRoom13Guest, fGuest13Moved);    }  }  [ if Jerrod is not falling off the ledgeif (!isset(fIsFalling))  {  [ set loop based on direction  if ((egoDir == UP ||       egoDir == UP_RIGHT ||       egoDir == RIGHT ||       egoDir == DOWN_RIGHT))    {    set.loop(ego, 0);    }  if ((egoDir == DOWN ||       egoDir == DOWN_LEFT ||       egoDir == LEFT ||       egoDir == UP_LEFT))    {    set.loop(ego, 1);    }  }  [ if Jerrod is not fallingif (!isset(fIsFalling))  {  [ if Jerrod was startled by guest at window OR strayed too  [ far off ledge (by moving in down direction)  if (isset(egoHitSpecial))    {    [ change loop to show Jerrod falling    set.loop(ego, 2);    fix.loop(ego);    vDX = 10;    vDY = 167;    [ move Jerrod to bottom of screen    move.obj.v(ego, EgoX, vDY, vDX, fDoneFalling);    [ set the falling flag    set(fIsFalling);    [ stop playing the warning music (this is a minor bug -    [ resetting fMusicDone BEFORE stopping the sound doesn't    [ work - first of all, if the sound is still playing,    [ flag is already reset; secondly, calling stop.sound    [ automatically sets the flag to TRUE; but since the    [ code that restarts the music checks for Jerrod falling    [ it doesn't matter that the flag is TRUE)    reset(fMusicDone);    stop.sound();    }  }  [ when Jerrod finishes falling off the ledgeif (isset(fDoneFalling))  {  [ reset the flag  reset(fDoneFalling);  [ remove Jerrod from screen  erase(ego);  [ no more input  prevent.input();  stop.motion(ego);  [ show death message  display(22, 0, "Ledge walkin' can be hazardous!");  [ play death sound  sound(m.Death, fSndDone);  [ Jerrod is officially dead  set(JerrodIsDead);  }  [ if window 12 is finished opening/closingif (isset(fWindowMoved))  {  [ reset the flag  reset(fWindowMoved);  [ stop updating the window  stop.update(oWindow12);  }[ **************************************[ CHECK FOR AN EXIT CONDITION[ **************************************[ if Jerrod is at left edge of ledgeif (posn(ego, 4, 94, 5, 96))  {  [ set loop and position to correct values for the next  [ room  set.loop(ego, 1);  egoDir = STOPPED;  position(ego, 126, 87);  [ move to Green Pastures hotel exterior  new.room(rm.GreenPastures); [ ##LE001##  }  [ if Jerrod is at right edge of ledgeif (posn(ego, 139, 94, 140, 96))  {  [ set loop and position to correct values for the next  [ room  set.loop(ego, 0);  position(ego, 3, 95);  [ move to edge on right side of building  new.room(rm.LedgeRight); [ ##LE002##  }[ **************************************[ PROCESS PLAYER INPUT[ **************************************[ if player hasn't provided input no need to do said testsif (!isset(haveInput))  {  goto(Done);  }  [ unlock window/open latchif ((said("diconnect", "glass") ||     said("unlock", "glass") ||     said("open", "latch")))  {  [ if Jerrod is by either window  if ((posn(ego, 32, 94, 59, 96) ||        posn(ego, 102, 94, 128, 96)))    {    [ if by room 13    if (posn(ego, 32, 94, 59, 96))      {      print("Why would ya do that? The window's open!");      }    [ if by room 12    if (posn(ego, 102, 94, 128, 96))      {      [ if window is already open      if (isset(Window12Open))        {        print("Why would ya do that? The window's open!");        }      else        {        [ if window is broken        if (isset(Window12Broken))          {          [ unlatch it!          print("Ya reach through the broken glass and unlatch the window.");          set(Window12Unlatched);          }        else          {          print("Ya cain't do that through the window.");          }        }      }    }  else    {    print("Yer not close enough to a window.");    }  }  [ latch window/lock windowif ((said("latch", "glass") || said("lock", "glass")))  {  [ if by either window  if ((posn(ego, 32, 94, 59, 96) ||       posn(ego, 102, 94, 128, 96)))    {    [ if by room 13    if (posn(ego, 32, 94, 59, 96))      {      print("Why would ya do that? The window's open!");      }    [ if by room 12    if (posn(ego, 102, 94, 128, 96))      {      [ if window is open      if (isset(Window12Open))        {        print("Why would ya do that? The window's open!");        }      else        {        [ if window is broken        if (isset(Window12Broken))          {          [ latch it!          print("Ya reach through the broken glass and latch the window.");          reset(Window12Unlatched);          }        else          {          print("Ya cain't do that through the window.");          }        }      }    }  else    {    print("Yer not close enough to a window.");    }  }  [ open windowif (said("open", "glass"))  {  [ if by either window  if ((posn(ego, 32, 94, 59, 96) ||       posn(ego, 102, 94, 128, 96)))    {    [ if by room 13    if (posn(ego, 32, 94, 59, 96))      {      print("This window's already open.");      }    [ if by room 12    if (posn(ego, 102, 94, 128, 96))      {      [ if window is already open      if (isset(Window12Open))        {        print("This window's already open.");        }      else        {        [ if window is unlatched        if (isset(Window12Unlatched))          {          [ open it          print("Ya open the window.");          set(Window12Open);          start.update(oWindow12);          end.of.loop(oWindow12, fWindowMoved);          }        else          {          print("Ya cain't do that. The window is latched!");          }        }      }    }  else    {    print("Yer not close enough to a window.");    }  }  [ close windowif (said("close", "glass"))  {  [ if by either window  if ((posn(ego, 32, 94, 59, 96) ||       posn(ego, 102, 94, 128, 96)))    {    [ if by room 13    if (posn(ego, 32, 94, 59, 96))      {      print("It looks like there's someone inside. I wouldn't!");      }    [ if by room 12    if (posn(ego, 102, 94, 128, 96))      {      [ if window is open      if (isset(Window12Open))        {        [ close it        print("Ya close the window.");        start.update(oWindow12);        reverse.loop(oWindow12, fWindowMoved);        reset(Window12Open);        }      else        {        print("The window's already closed.");        }      }    }  else    {    print("Yer not close enough to a window.");    }  }  [ break windowif (said("break", "glass"))  {  [ if by either window  if ((posn(ego, 32, 94, 59, 96) ||       posn(ego, 102, 94, 128, 96)))    {    [ if by room 13    if (posn(ego, 32, 94, 59, 96))      {      print("Why would ya do that? The window's open!");      }    [ if by room 12    if (posn(ego, 102, 94, 128, 96))      {      [ if Jerrod knows about Jake's room      if (isset(ScoreLetterClue))        {        [ if window is open        if (isset(Window12Open))          {          print("Why would ya do that? The window's open!");          }        else          {          [ if window is already broken          if (isset(Window12Broken))            {            print("The window's already broken.");            }          else            {            [ play sound            sound(s.WindowBreak, fSndDone);            [ break the window            print("As quietly as ya can, ya bust the hotel window!");            [ change to broken window loop            set.loop(oWindow12, 4);            [ force it to draw             force.update(oWindow12);            set(Window12Broken);            [ lose two points - this is not the best way to            [ get into Jake's room            currentScore -= 2;            }          }        }      else        {        [ Jerrod doesn't know about the room yet        print("You know you could do that, but right now you have no reason to.");        }      }    }  else    {    print("Yer not close enough to a window.");    }  }  [ crawl in windowif ((said("crawl", "glass") ||     said("crawl", "in", "glass") ||     said("crawl", "around") ||     said("crawl", "in", "around") ||     said("crawl", "room 12") ||     said("crawl", "in", "room 12") ||     said("climb", "glass") ||     said("climb", "in", "glass") ||     said("climb", "around") ||     said("climb", "in", "around") ||     said("climb", "room 12") ||     said("climb", "in", "room 12") ||     said("go", "glass") ||     said("go", "in", "glass") ||     said("go", "around") ||     said("go", "room 12") ||     said("go", "in", "room 12") ||     said("enter", "around") ||     said("enter", "room 12")))  {  [ if by either window  if ((posn(ego, 32, 94, 59, 96) ||       posn(ego, 102, 94, 128, 96)))    {    [ if by room 13    if (posn(ego, 32, 94, 59, 96))      {      print("It looks like there's someone inside. I wouldn't!");      }    [ if by room 12    if (posn(ego, 102, 94, 128, 96))      {      [ if window is open      if (isset(Window12Open))        {        [ crawl through        print("Bein' mighty careful not to fall offa the ledge, ya crawl "              "through the window.");        [ set position and loop for next room        position(ego, 78, 102);        set.loop(ego, 2);        egoDir = STOPPED;        [ move into room 12        new.room(rm.Hotel12); [ ##LE003##        }      else        {        print("Ya cain't do that through the window.");        }      }    }  else    {    print("Yer not close enough to a window.");    }  }  [ look window/look in windowif ((said("examine", "glass") ||     said("examine", "in", "glass")))  {  [ if by either window  if ((posn(ego, 32, 94, 59, 96) ||       posn(ego, 102, 94, 128, 96)))    {    [ if by room 13    if (posn(ego, 32, 94, 59, 96))      {      print("This is room 13. Ya notice nothin' unusual.");      }    else      {      [ if room 12 window is open      if (isset(Window12Open))        {        print("Ya see a dusty hotel room. No one has been in this room fer a "              "long time. There is a fireplace on the right side of the room. "              "That's strange...");        print("...there's no door to this room!");        }      else        {        [ if room 12 window is closed and broken        if (isset(Window12Broken))          {          print("Ya see a dusty hotel room. No one has been in this room fer a "                "long time. There is a fireplace on the right side of the room. "                "That's strange...");          print("...there's no door to this room!");          }        else          {          [ room 12 window is closed, not broken          print("It is difficult to see through the dusty window. All you can "                "see is a fireplace on the right side of the room. That's "                "strange...");          print("...there's no door to this room!");          }        }      }    }  else    {    print("Yer not close enough to a window.");    }  }  [ look manif ((said("examine", "boy") ||     said("examine", "girl") ||     said("examine", "boy", "glass") ||     said("examine", "girl", "glass") ||     said("examine", "boy", "in", "glass") ||     said("examine", "girl", "in", "glass")))  {  [ if by room 13 window  if (posn(ego, 32, 94, 59, 96))    {    print("This man will kill you if he catches you walkin' past his window!");    }  else    {    print("Yer not close enough to a window.");    }  }  [ look/look aroundif ((said("examine", "around") ||     said("examine") ||     said("examine", "hotel") ||     said("examine", "green", "pasture", "hotel") ||     said("examine", "green", "pasture")))  {  print("Yer walkin' the ledge at Green Pastures Hotel!");  }  [ look downif (said("examine", "down"))  {  print("It's ain't that far down, but fallin' might be fatal!");  }  [ look message/read messageif ((said("examine", "message") ||     said("read", "message") ||     said("open", "message")))  {  if (has("Message for room 11"))    {    print("Not now! Ya might fall off the ledge!");    }  else    {    print("Ya don't have a message.");    }  }  [ look ledgeif (said("examine", "ledge"))  {  print("You carefully side-step on the ledge past the windows.");  }  [ look wallif (said("examine", "wall"))  {  print("You've got yer back up against a wall!");  }  Done:return();[ **************************************[ MESSAGES[ **************************************#message 1 "Ledge walkin' can be hazardous!"#message 2 "Yer not close enough to a window."#message 3 "This window's already open."#message 4 "Ya reach through the broken glass and unlatch the window."#message 5 "Ya cain't do that through the window."#message 6 "Ya open the window."#message 7 "Ya cain't do that. The window is latched!"#message 8 "It looks like there's someone inside. I wouldn't!"#message 9 "Ya close the window."#message 10 "The window's already closed."#message 11 "Why would ya do that? The window's open!"#message 12 "Ya reach through the broken glass and latch the window."#message 13 "You know you could do that, but right now you have no reason to."#message 14 "The window's already broken."#message 15 "As quietly as ya can, ya bust the hotel window!"#message 16 "Bein' mighty careful not to fall offa the ledge, ya crawl through the window."#message 19 "Yer walkin' the ledge at Green Pastures Hotel!"#message 20 "It's ain't that far down, but fallin' might be fatal!"#message 22 "Not now! Ya might fall off the ledge!"#message 23 "Ya don't have a message."#message 24 "This is room 13. Ya notice nothin' unusual."#message 25 "Ya see a dusty hotel room. No one has been in this room fer a long time. There is a fireplace on the right side of the room. That's strange..."#message 26 "It is difficult to see through the dusty window. All you can see is a fireplace on the right side of the room. That's strange..."#message 27 "You've got yer back up against a wall!"#message 30 "This man will kill you if he catches you walkin' past his window!"#message 31 "You carefully side-step on the ledge past the windows."#message 32 "...there's no door to this room!"