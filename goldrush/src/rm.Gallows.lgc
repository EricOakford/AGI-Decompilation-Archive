[***********************************************************[[ rm.Gallows[[ This room gets called at beginning if copy protection[ fails; it's also called from multiple places in the game[ when Jerrod gets caught in various situations doing [ something wrong, like jumping a claim, or breaking into a[ hotel room when someone is in it.[[ The room tries to use the close.window() command to manage[ various print messages, but none of the print messages use[ the leaveWindow flag correctly, so the messages don't work[ as the programmers intended. (They all have to be dismissed[ as they appear instead of doing so on a timer.) [[***********************************************************[ **************************************[ LOCAL DEFINES[ **************************************#define oTrapDoor                    o1#define oNoose                       o2#define oRope                        o3#define oMouth                       o4#define oGuard1                      o5#define oGuard2                      o6#define vDX                        v220#define vStartMsgTimer             v221#define vStairsMsgTimer            v222#define vSequencePhase             v223#define vSequenceTimer             v224#define vDY                        v225#define vTmpCel                    v226#define vStallStart                v227[ f220 is not used#define fOnTrapdoor                f221#define fIsHung                    f221  [ override fOnTrapdoor#define fStalling                  f222#define fGuard1Done                f223#define fGuard2Done                f224[ **************************************[ FIRST CYCLE ONLY[ **************************************if (isset(newRoom))  {  [ reset speed to normal  animationInterval = 2;    [ load picture for current room  load.pic(currentRoom);    [ load view used in the room  load.view(vw.Gallows);    [ load sound used in the room  load.sound(m.Death);    [ draw the picture  draw.pic(currentRoom);    [ add rope to the scene  add.to.pic(vw.Gallows, 1, 2, 87, 59, 12, 12);  add.to.pic(vw.Gallows, 1, 3, 113, 84, 12, 12);    [ add spectators  add.to.pic(vw.Gallows, 1, 5, 152, 158, 0, 4);  add.to.pic(vw.Gallows, 1, 6, 71, 98, 11, 11);  add.to.pic(vw.Gallows, 5, 0, 21, 80, 0, 4);  add.to.pic(vw.Gallows, 5, 1, 53, 77, 0, 4);  add.to.pic(vw.Gallows, 5, 2, 146, 92, 0, 4);  add.to.pic(vw.Gallows, 5, 3, 139, 87, 0, 4);  add.to.pic(vw.Gallows, 5, 4, 128, 83, 0, 4);  add.to.pic(vw.Gallows, 5, 5, 153, 103, 0, 4);  add.to.pic(vw.Gallows, 5, 6, 6, 89, 0, 4);  add.to.pic(vw.Gallows, 5, 7, 59, 80, 0, 4);    [ the guards who walk next to Jerrod  animate.obj(oGuard1);  set.view(oGuard1, vw.Gallows);  set.loop(oGuard1, 7);  fix.loop(oGuard1);  ignore.blocks(oGuard1);  ignore.objs(oGuard1);  position(oGuard1, 25, 122);  draw(oGuard1);  stop.cycling(oGuard1);  [ guard #2  animate.obj(oGuard2);  set.view(oGuard2, vw.Gallows);  set.loop(oGuard2, 6);  fix.loop(oGuard2);  position(oGuard2, 11, 140);  draw(oGuard2);  stop.cycling(oGuard2);    [ Jerrod's mouth for his last words  animate.obj(oMouth);  set.view(oMouth, vw.Gallows);  set.loop(oMouth, 3);  set.priority(oMouth, 13);  position(oMouth, 84, 72);    [ the hanging rope ; it will stretch taut when Jerrod  [ drops  animate.obj(oRope);  set.view(oRope, vw.Gallows);  set.loop(oRope, 1);  set.cel(oRope, 0);  set.priority(oRope, 12);  position(oRope, 90, 77);  draw(oRope);  stop.cycling(oRope);  stop.update(oRope);    [ the noose  animate.obj(oNoose);  set.view(oNoose, vw.Gallows);  set.loop(oNoose, 1);  set.cel(oNoose, 4);  set.priority(oNoose, 11);  position(oNoose, 86, 84);  draw(oNoose);  stop.update(oNoose);    [ the trap door  animate.obj(oTrapdoor);  set.view(oTrapdoor, vw.Gallows);  set.loop(oTrapdoor, 2);  set.cel(oTrapdoor, 0);  ignore.objs(oTrapdoor);  set.priority(oTrapdoor, 11);  position(oTrapdoor, 75, 128);  draw(oTrapdoor);  stop.cycling(oTrapdoor);    [ poor Jerrod  animate.obj(ego);  set.view(ego, vw.Gallows);  set.loop(ego, 4);  fix.loop(ego);  set.priority(ego, 12);  position(ego, 20, 131);  draw(ego);  egoDir = STOPPED;  [ re-use vDX to change step size  vDX = 2;  step.size(ego, vDX);    [ clear the special status line just in case there was  [ something there  clear.lines(24, 24, BLACK);    [ now show the picture  show.pic();    [ no input while Jerrod is marching to his death...  prevent.input();  }[ **************************************[ EVERY CYCLE[ **************************************[ if the start message timer is activeif (vStartMsgTimer > 0)  {  [ increment the timer  ++vStartMsgTimer;  [ after 35 cycles  if (vStartMsgTimer == 35)    {    [ reset timer    vStartMsgTimer = 0;    [ close any open message windows (this doesn't acutally    [ do anything; only one message uses this timer, and it    [ does not use the leaveWindow flag, so the window is    [ already closed)    close.window();    }  }  [ if the stairs message timer is activeif (vStairsMsgTimer > 0)  {  [ increment the timer  ++vStairsMsgTimer;  [ after 35 cycles  if (vStairsMsgTimer == 35)    {    [ reset timer    vStairsMsgTimer = 0;    [ close any open message windows (this doesn't acutally    [ do anything; only one message uses this timer, and it    [ does not use the leaveWindow flag, so the window is    [ already closed)    close.window();    }  }  [ if Jerrod hasn't started to move yet if (posn(ego, 20, 131, 20, 131) && !isset(fStalling))  {  [ increment stall counter  ++vStallStart;    [ after 40 cycles  if (vStallStart == 40)    {    [ Jerrod needs to get moving    print.at("\"Come on ya yellow-bellied coward! No one's gonna walk up there "             "for ya!\"", 2, 3, 0);    }      [ after 120 cycles  if (vStallStart == 120)    {    [ close any open message windows (this doesn't acutally    [ do anything; the leaveWindow flag is not used, so the    [ window is already closed)    close.window();    [ reset timer    vStallStart = 0;    }  }[ if Jerrod is still on the grass he is only allowed to move[ forwardif (posn(ego, 20, 130, 35, 132))  {  [ if Jerrod's motion is anything except to the right  if ((egoDir == UP ||       egoDir == UP_RIGHT ||       egoDir == DOWN_RIGHT ||       egoDir == DOWN ||       egoDir == DOWN_LEFT ||       egoDir == LEFT ||       egoDir == UP_LEFT))    {    [ Jerrod is stalling    set(fStalling);    [ stop his movement    egoDir = STOPPED;    [ give Jerrod a warning    print.at("\"Not that way, ya low-down slug! Walk straight ahead!\"", 2, 3, 0);    [ start the timer    vStartMsgTimer = 1;    }    [ if Jerrod is moving to the right  if (egoDir == RIGHT)    {    [ close the warning message    close.window();    [ and reset the timer    vStartMsgTimer = 0;    }  }  [ if Jerrod is at or on stairs, allowed motion is up,[ up-right or rightif (posn(ego, 36, 104, 61, 132))  {  [ if motion is not up, up-right, or right  if ((egoDir == DOWN_RIGHT ||       egoDir == DOWN ||       egoDir == DOWN_LEFT ||       egoDir == LEFT ||       egoDir == UP_LEFT))    {    [ stop Jerrod's movement (but no stalling flag here)    egoDir = STOPPED;    [ give Jerrod a warning    print.at("\"Not that way, ya low-down slug! Get up those stairs!\"", 2, 3, 0);    [ start the timer    vStairsMsgTimer = 1;    }      [ on the stairs, the actual direction is always 'up-right'  if ((egoDir == UP ||       egoDir == UP_RIGHT ||       egoDir == RIGHT))    {    [ change direction to up-right    egoDir = UP_RIGHT;    [ close any open message windows (this doesn't acutally    [ do anything; the leaveWindow flag is not used, so the    [ window is already closed)    close.window();    [ reset the timer    vStairsMsgTimer = 0;    }  }[ if Jerrod is on the grassif (posn(ego, 20, 130, 35, 132))  {  [ if Jerrod is moving  if (egoDir == RIGHT)    {    [ if guard #1 has not reached his destination    if (!isset(fGuard1Done))      {      [ guard #1 moves alongside Jerrod      start.cycling(oGuard1);      move.obj(oGuard1, 37, 122, 2, fGuard1Done);      }    [ if guard #2 has not reached his destination    if (!isset(fGuard2Done))      {      [ guard #2 moves alongside Jerrod      start.cycling(oGuard2);      move.obj(oGuard2, 31, 140, 2, fGuard2Done);      }    }      [ if Jerrod is stopped  if (egoDir == STOPPED)    {    [ the guards also stop    stop.cycling(oGuard1);    stop.motion(oGuard1);    stop.cycling(oGuard2);    stop.motion(oGuard2);    }  }[ if guard #1 is done movingif (isset(fGuard1Done))  {  [ guard #1 stops cycling  stop.cycling(oGuard1);  }[ if guard #2 is done movingif (isset(fGuard2Done))  {  [ guard #2 stops cycling  stop.cycling(oGuard2);  }[ once Jerrod reaches topif (posn(ego, 62, 105, 64, 105) && vSequencePhase == 0)  {  [ Jerrod moves to the trapdoor  vSequencePhase = 1;  move.obj(ego, 80, 105, 2, fOnTrapdoor);  }[ when Jerrod reaches trap door if (isset(fOnTrapdoor) && vSequencePhase == 1)  {  [ reset trapdoor flag  reset(fOnTrapdoor);  [ advance to next stage (pause before getting last words)  vSequencePhase = 2;    [ adjust Jerrod's position to account for the taller view  [ that shows Jerrod dropping through the trapdoor  vDX = 1;  vDY = 23;  reposition(ego, vDX, vDY);  [ assign the loop showing noose around Jerrod's neck  set.loop(ego, 0);  set.cel(ego, 0);  [ allow updating (not necessary - objects can be erased  [ even if they are not updating)  start.update(oNoose);  [ erase the old noose object (it's not needed anymore)  erase(oNoose);  stop.motion(ego);  }[ if pausing before final wordsif (vSequencePhase == 2)  {  [ increment timer  ++vSequenceTimer;  [ after 20 cycles  if (vSequenceTimer == 20)    {    [ reset timer    vSequenceTimer = 0;    [ advance to next stage (Jerrod finishes speaking)    vSequencePhase = 3;        [ leave print message open while getting last words from    [ the player    set(leaveWindow);    print.at("Do ya got any last words?", 2, 10, 25);        [ accept.input() is not necessary; it has no effect on    [ the get.string (or get.num) commands    accept.input();    [ use get.string to let player provide their last words    get.string(s1, "Last words: ", 23, 0, 27);    prevent.input();        [ leave print message open while Jerrod speaks    set(leaveWindow);    print.at("Ya utter \"%s1\" and the trap door falls open...", 2, 10, 25);    [ draw the mouth object so we see Jerrod speaking    draw(oMouth);    }  }[ when Jerrod finishes speakingif (vSequencePhase == 3)  {  [ increment timer  ++vSequenceTimer;  [ after 40 cycles  if (vSequenceTimer == 40)    {    [ drop him through trap door    vSequenceTimer = 0;    vSequencePhase = 4;    [ close the print message window    close.window();    [ erase Jerrod's mouth object    erase(oMouth);    [ allow ego to cycle at rest    set(CycleAtRest);    [ allow rope to update    start.update(oRope);    [ open trapdoor    end.of.loop(oTrapdoor, DoneNoAction);    [ Jerrod falls through trapdoor    end.of.loop(ego, fIsHung);    }  }  [ after Jerrod falls through trapdoorif (vSequencePhase == 4)  {  [ get current ego cel  current.cel(ego, vTmpCel);  [ if Jerrod has reached end of the rope  if (vTmpCel == 4)    {    [ ajust rope so it goes taut    set.cel(oRope, 1);    }      [ once Jerrod is hung  if (isset(fIsHung))    {    [ advance stage to end    reset(fIsHung);    vSequencePhase = 5;        [ play death sound    sound(m.Death, DoneNoAction);        [ input is already prevented; no need to call it again    [ here    prevent.input();        [ if Jerrod is hung for failing copy protection check    if ((previousRoom == lgc.CopyProt_1 ||        previousRoom == lgc.CopyProt_2 ||         previousRoom == lgc.CopyProt_3))      {      [ quit without warning      quit(1);      }          [ otherwise, note that Jerrod is dead and continue    [ (player will get a chance to restore or restart later)    set(JerrodIsDead);    display(22, 0, "It's an utter pity that yer trip to California turned out "            "like this, ain't it?");    }  }[ boilerplate code that they should have removedif (!isset(haveInput))  {  goto(Done);  }  Done:return();[ **************************************[ MESSAGES[ **************************************#message 1 "\"Come on ya yellow-bellied coward! No one's gonna walk up there for ya!\""#message 2 "\"Not that way, ya low-down slug! Walk straight ahead!\""#message 3 "\"Not that way, ya low-down slug! Get up those stairs!\""#message 4 "Do ya got any last words?"#message 5 "Last words: "#message 6 "Ya utter \"%s1\" and the trap door falls open..."#message 7 "It's an utter pity that yer trip to California turned out like this, ain't it?"