[***********************************************************[[ rm.StageCoachOffice[[ The stagecoach office is where Jerrod has to go to buy a[ stagecoach ticket; the grocery clerk, livery midget, and [ Jerrod's boss at the paper will occasionally walk by.[[***********************************************************[ **************************************[ LOCAL DEFINES[ **************************************#define oDoor                        o1#define oHorse1                      o2#define oHorse2                      o3#define oCoach                       o4#define oWagon                       o5#define oPedestrian                  o6#define vCoachStatus               v220#define vWagonStatus               v221#define vPedStatus                 v222#define vWagonDist                 v223#define vPedDist                   v224#define vTmpDir                    v225[ v226 - v231 are not used#define vPedX                      v232#define vPedY                      v233#define fDoorOpen                  f220#define fDoorMoved                 f221[ f222 is not used#define fHorsesMoved               f223#define fCoachMoved                f224#define fWagonMoved                f225#define fPedMoved                  f226#define fRunOver                   f227#define fDoneDying                 f228[ f229 is not used#define fEffectDone                f230[ **************************************[ FIRST CYCLE ONLY[ **************************************if (isset(newRoom))  {  [ load the current room picture  load.pic(currentRoom);    [ load views used in the room  load.view(vw.JerrodNY);  load.view(vw.DyingJerrodNY);  load.view(vw.SkylineArt);  load.view(vw.CoachOfficeArt);  [ if this is NOT a cutscene with the stagecoach driving  [ by on its way to the ferry dock  if (StagecoachPhase != SC_TRAVELLING)    {    [ there is a regular street wagon in the room    load.view(vw.Wagon);    }  else    {    [ the stagecoach is here    load.view(vw.StageCoach);    }  load.view(vw.GrocerClerk);  load.view(vw.Midget);  load.view(vw.PaperBoss);    [ load sounds used in the room  load.sound(s.UhOh);  load.sound(m.Death);  load.sound(s.Effect1);  load.sound(s.Effect2);    [ draw the room  draw.pic(currentRoom);    [ add skyline art  add.to.pic(vw.SkylineArt, 0, 1, 0, 52, 4, 4);  add.to.pic(vw.SkylineArt, 0, 2, 20, 52, 4, 4);  add.to.pic(vw.SkylineArt, 0, 3, 40, 52, 4, 4);  add.to.pic(vw.SkylineArt, 0, 4, 60, 52, 4, 4);  add.to.pic(vw.SkylineArt, 0, 5, 80, 52, 4, 4);  add.to.pic(vw.SkylineArt, 0, 6, 100, 52, 4, 4);  add.to.pic(vw.SkylineArt, 0, 7, 120, 52, 4, 4);  add.to.pic(vw.SkylineArt, 0, 8, 140, 52, 4, 4);  [ add front door (not used for entry)  add.to.pic(vw.CoachOfficeArt, 0, 0, 71, 89, 6, 6);  [ add interior background art behind side door  add.to.pic(vw.CoachOfficeArt, 3, 0, 61, 93, 6, 6);    [ animate the side door  animate.obj(oDoor);  set.view(oDoor, vw.CoachOfficeArt);  set.loop(oDoor, 1);  [ if coming from inside the office,  if (previousRoom == rm.StageOfficeInterior)    {    [ show the door open    set.cel(oDoor, 3);    }  else    {    [ show the door closed    set.cel(oDoor, 0);    }  set.priority(oDoor, 9);  position(oDoor, 61, 93);  ignore.objs(oDoor);  draw(oDoor);  stop.update(oDoor);    [ add sign to side of building  add.to.pic(vw.CoachOfficeArt, 2, 0, 26, 39, 9, 9);    [ if this is NOT a cutscene with the stagecoach driving  [ by on its way to the ferry dock  if (StagecoachPhase != SC_TRAVELLING)    {    [ animate a street wagon    animate.obj(oWagon);    set.view(oWagon, vw.Wagon);    [ choose a random starting point and direction    random(0, 1, vWagonDist);    if (vWagonDist == 0)      {      set.loop(oWagon, 0);      position(oWagon, 0, 160);      draw(oWagon);      move.obj(oWagon, 112, 160, 2, fWagonMoved);      }    else      {      set.loop(oWagon, 1);      position(oWagon, 112, 160);      draw(oWagon);      move.obj(oWagon, 0, 160, 2, fWagonMoved);      }    [ next destination is end point    vWagonStatus = 1;    }      [ the pedestrian can be one of three different people  animate.obj(oPedestrian);  [ and starts off screen  vPedStatus = 10;    [ if this is a cutscene with the stagecoach driving by on  [ its way to the ferry dock  if (StagecoachPhase == SC_TRAVELLING)    {    [ add horse teams and stagecoach and start them moving    [ across the room        [ horse team #1    animate.obj(oHorse1);    set.view(oHorse1, vw.StageCoach);    set.loop(oHorse1, 1);    fix.loop(oHorse1);    ignore.objs(oHorse1);    ignore.blocks(oHorse1);    position(oHorse1, 78, 151);    draw(oHorse1);    [ horse team #2    animate.obj(oHorse2);    set.view(oHorse2, vw.StageCoach);    set.loop(oHorse2, 2);    fix.loop(oHorse2);    ignore.objs(oHorse2);    ignore.blocks(oHorse2);    position(oHorse2, 102, 153);    draw(oHorse2);    [ stagecoach    animate.obj(oCoach);    set.view(oCoach, vw.StageCoach);    set.loop(oCoach, 0);    set.cel(oCoach, 0);    fix.loop(oCoach);    ignore.objs(oCoach);    ignore.blocks(oCoach);    position(oCoach, 125, 155);    draw(oCoach);    [ horse teams and stagecoach move across the room    move.obj(oHorse1, 49, 151, 1, fHorsesMoved);    start.cycling(oHorse1);    move.obj(oHorse2, 73, 153, 1, fHorsesMoved);    start.cycling(oHorse2);    move.obj(oCoach, 97, 155, 1, fCoachMoved);    start.cycling(oCoach);    [ set coach status to beginning    vCoachStatus = 1;    }      [ if this is NOT a cutscene with the stagecoach driving  [ by on its way to the ferry dock  if (StagecoachPhase != SC_TRAVELLING)    {    [ add Jerrod, in his normal Brooklyn attire    animate.obj(ego);    set.view(ego, vw.JerrodNY);    [ adjust Jerrod's position, depending on which room he    [ came from    if (previousRoom == rm.Livery)      {      position(ego, 152, 154);      }    if (previousRoom == rm.StageOfficeInterior)      {      [ the door is open (not sure why they didn't set this      [ flag at the same time they set the cel when the       [ screen object is initialized)      set(fDoorOpen);      position(ego, 66, 93);      }    [ add Jerrod to the room    draw(ego);    }      [ now show the picture  show.pic();  }  [ **************************************[ EVERY CYCLE[ **************************************[ if wagon has reached its destinationif (isset(fWagonMoved) && vWagonStatus == 1)  {  [ remove it from screen  reset(fWagonMoved);  erase(oWagon);  vWagonStatus = 10;  }  [if Jerrod is in the path of the wagon, and not runover yetif (EgoY == 160 && EgoHealthStatus == 0)  {  [ get distance from Jerrod to the wagon  distance(ego, oWagon, vWagonDist);  get.dir(oWagon, vTmpDir);  [ distance to get hit varies slightly depending on  [ direction of wagon  if (vTmpDir == LEFT)    {    if ((vWagonDist == 30 || vWagonDist == 29))      {      [ Jerrod gets run over      set(fRunOver);      }    }  if (vTmpDir == RIGHT)    {    if ((vWagonDist == 28 ||vWagonDist == 29))      {      [ Jerrod gets run over      set(fRunOver);      }    }  }  [ if Jerrod is run overif (isset(fRunOver))  {  [ reset the flag  reset(fRunOver);  [ allow the wagon to roll over his dead body  ignore.objs(ego);  [ change to dying view  set.view(ego, vw.DyingJerrodNY);  [ make sure to start at first cel  set.cel(ego, 0);  [ allow ego object to cycle at rest  set(CycleAtRest);  [ run loop one time to show Jerrod falling down dead  end.of.loop(ego, fDoneDying);  [ change status to 'death by getting run over'  EgoHealthStatus = 4;  }  [ after Jerrod finishes dyingif (isset(fDoneDying))  {  [ reset the flag  reset(fDoneDying);  [ call the death logic to handle details of death  call(lgc.DeathRunOver);  }[ if wagon is not on screenif (vWagonStatus > 9)  {  [ random chance it will reappear  random(20, 100, vWagonStatus);  [ one in 80 chance  if (vWagonStatus == 77)    {    [ choose a random direction    random(0, 1, vWagonStatus);    if (vWagonStatus == 0)      {      set.loop(oWagon, 1);      position(oWagon, 112, 160);      draw(oWagon);      move.obj(oWagon, 0, 160, 2, fWagonMoved);      }    else      {      set.loop(oWagon, 0);      position(oWagon, 0, 160);      draw(oWagon);      move.obj(oWagon, 112, 160, 2, fWagonMoved);      }    [ next destination is end point    vWagonStatus = 1;    }  }  [ if pedestrian is not on screenif (vPedStatus > 9)  {  [ random chance he appears  random(25, 100, vPedStatus);  [ one in 75 chance  if (vPedStatus == 77)    {    [ choose one of three pedestrians    random(0, 2, vPedStatus);    if (vPedStatus == 0)      {      set.view(oPedestrian, vw.Midget);      }    if (vPedStatus == 1)      {      set.view(oPedestrian, vw.GrocerClerk);      }    if (vPedStatus == 2)      {      set.view(oPedestrian, vw.PaperBoss);      }    [ choose a random starting location and direction    random(0, 1, vPedStatus);    if (vPedStatus == 0)      {      set.loop(oPedestrian, 0);      position(oPedestrian, 0, 152);      draw(oPedestrian);      move.obj(oPedestrian, 152, 152, 1, fPedMoved);      [ next destination is end point      vPedStatus = 9;      }    if (vPedStatus == 1)      {      set.loop(oPedestrian, 1);      position(oPedestrian, 152, 152);      draw(oPedestrian);      move.obj(oPedestrian, 0, 152, 1, fPedMoved);      [ next destination is end point      vPedStatus = 9;      }    }  }  [ if pedestrian reaches end pointif (isset(fPedMoved) && vPedStatus == 9)  {  [ remove him from screen  reset(fPedMoved);  vPedStatus = 10;  erase(oPedestrian);  }  [ get pedestrian's current locationget.posn(oPedestrian, vPedX, vPedY);[ if pedestrian is not moving (blocked by Jerrod)if (OldObj1X == vPedX && OldObj1Y == vPedY)  {  [ stop cycling when not moving  stop.cycling(oPedestrian);  }else  {  [ otherwise, cycle while moving  start.cycling(oPedestrian);  }[ save pedestrian's locationOldObj1X = vPedX;OldObj1Y = vPedY;[ if Jerrod is by the door and it is not openif (posn(ego, 54, 91, 64, 99) && !isset(fDoorOpen))  {  [ play door-open sound  sound(s.Effect1, fEffectDone);  [ open the door  start.update(oDoor);  end.of.loop(oDoor, fDoorMoved);  set(fDoorOpen);  }  [ if Jerrod is NOT by the door and it is openif (!posn(ego, 54, 91, 64, 99) && isset(fDoorOpen))  {  [ close the door  start.update(oDoor);  reverse.loop(oDoor, fDoorMoved);  reset(fDoorOpen);  }  [ if door is done movingif (isset(fDoorMoved))  {  [ reset the flag  reset(fDoorMoved);  [ door is done updating  stop.update(oDoor);  [ if door is now closed  if (!isset(fDoorOpen))    {    [ play door-closed sound    sound(s.Effect2, fEffectDone);    }  }  [ if the stagecoach has reached its first pointif (isset(fCoachMoved) && vCoachStatus == 1)  {  [ move the horses and the coach to second point  reset(fCoachMoved);  vCoachStatus = 2;  move.obj(oHorse1, 1, 137, 1, fHorsesMoved);  move.obj(oHorse2, 24, 139, 1, fHorsesMoved);  move.obj(oCoach, 48, 141, 1, fCoachMoved);  }  [ **************************************[ CHECK FOR AN EXIT CONDITION[ **************************************[ if stagecoach has reached second pointif (isset(fCoachMoved) && vCoachStatus == 2)  {  [ leave the room; stagecoach goes to the ferry dock  StagecoachPhase = SC_AT_FERRY;  new.room(rm.FerryDock); [ ##LE001##  }  [ top edge leads to rm.Stores; adjust Jerrod's position in [ the new room to account for perspectiveif (posn(ego, 80, 92, 90, 92))  {  position(ego, 20, 160);  new.room(rm.Stores); [ ##LE002##  }if (posn(ego, 91, 92, 109, 92))  {  position(ego, 58, 166);  new.room(rm.Stores); [ ##LE003##  }if (posn(ego, 110, 92, 125, 92))  {  position(ego, 82, 166);  new.room(rm.Stores); [ ##LE004##  }if (posn(ego, 126, 92, 137, 92))  {  position(ego, 111, 166);  new.room(rm.Stores); [ ##LE005##  }if (posn(ego, 138, 92, 150, 92))  {  position(ego, 127, 166);  new.room(rm.Stores); [ ##LE006##  }  [ if in the doorway to the stage officeif ((posn(ego, 52, 85, 60, 85) || posn(ego, 52, 72, 52, 93)))  {  new.room(rm.StageOfficeInterior); [ ##LE007##  }  [ check for normal edge hitif (edgeEgoHit != NOT_HIT)  {  if (edgeEgoHit == LEFT_EDGE)    {    new.room(rm.FerryDock); [ ##LE008##    }  if (edgeEgoHit == RIGHT_EDGE)    {    new.room(rm.Livery); [ ##LE009##    }  }  [ **************************************[ PROCESS PLAYER INPUT[ **************************************[ if player hasn't provided input no need to do said testsif (!isset(haveInput))  {  goto(Done);  }  [ look man/look midgetif ((said("examine", "boy") || said("examine", "midget")))  {  [ get distance to wagon and pedestrian  distance(ego, oWagon, vWagonDist);  distance(ego, oPedestrian, vPedDist);  [ if at least one is close enough  if ((vWagonDist < 60 || vPedDist < 60))    {    [ if pedestrian is close enough    if (vPedDist < 60)      {      [ use view number to determine identify of pedestrian      current.view(oPedestrian, vPedDist);      if (vPedDist == vw.Midget)        {        print("This short man works at the livery.");        }      if (vPedDist == vw.GrocerClerk)        {        print("This young man works at the grocery store.");        }      if (vPedDist == vw.PaperBoss)        {        print("This is your boss. He's the number one man at the Brooklyn "              "Evening Star.");        }      }    [ if wagon is close enough    if (vWagonDist < 60)      {      print("This man and wagon are flying down Fulton Street!");      }    }  else    {    [ if both are off screen    if (vWagonDist == 255 && vPedDist == 255)      {      print("There is no one around.");      }    else      {      print("There is no one close enough.");      }    }  }  [ talk man/talk midgetif ((said("speak", "boy") || said("speak") ||     said("speak", "midget")))  {  [ get distance to wagon and pedestrian  distance(ego, oWagon, vWagonDist);  distance(ego, oPedestrian, vPedDist);  [ if at least one is close enough  if ((vWagonDist < 40 || vPedDist < 40))    {    [ if pedestrian is close enough    if (vPedDist < 40)      {      [ use view to determine identity of pedestrian      current.view(oPedestrian, vPedDist);      if (vPedDist == vw.Midget)        {        print("The short man says, \"Hi, Jerrod. Stop by the livery sometime.\"");        }      if (vPedDist == vw.GrocerClerk)        {        print("The young man says, \"Have a nice day, Jerrod!\"");        }      if (vPedDist == vw.PaperBoss)        {        print("Your boss, as usual, says, \"Keep up the good work, Jerrod.\"");        }      }    [ if wagon is close enough    if (vWagonDist < 40)      {      print("The man on the wagon cannot hear you over the rumble of the wagon.");      }    }  else    {    [ if neither is on screen    if (vWagonDist == 255 && vPedDist == 255)      {      print("There is no one around.");      }    else      {      print("There is no one close enough.");      }    }  }  [ look buildingif (said("examine", "building"))  {  print("You see the stage travel building, the grocery store, the hardware "        "store and a portion of the livery.");  }  [ look roadif ((said("examine", "path") ||     said("examine", "water", "path") ||     said("examine", "fulton", "path")))  {  print("This is where Water Street and Fulton Street intersect.");  }  [ look wagonif (said("examine", "cart"))  {  [ get distance to see if wagon is on screen or not  distance(oWagon, ego, vWagonDist);  if (vWagonDist == 255)    {    print("There is no wagon here.");    }  else    {    print("That is a smooth-running team!");    }  }  [ look/look aroundif ((said("examine") ||     said("examine", "around") ||     said("examine", "coach", "office") ||     said("examine", "coach", "building") ||     said("examine", "coach", "journey") ||     said("examine", "coach", "journey", "building") ||     said("examine", "coach", "journey", "office") ||     said("examine", "journey", "office") ||     said("examine", "journey", "building")))  {  print("You are outside the \"Stage Travel\" building.");  }  [ look doorif (said("examine", "door"))  {  [ if Jerrod is near the stage office doors  if (posn(ego, 57, 90, 74, 100))    {    print("You notice nothing unusual about the door on the left, but there is "          "a small note on the other door.");    }  else    {    print("To get a good look you need to be closer.");    }  }  [ look note/read noteif ((said("examine", "note") || said("read", "note")))  {  [ if Jerrod is near the stage office doors  if (posn(ego, 57, 90, 74, 100))    {    print("The note says... ");    print(" PLEASE USE OTHER DOOR ");    }  else    {    print("To get a good look you need to be closer.");    }  }  [ take noteif (said("acquire", "note"))  {  print("You don't need the note.");  }  [ open doorif (said("open", "door"))  {  [ if near the stage office doors  if (posn(ego, 57, 90, 74, 100))    {    print("You are unable to open the door on the right.");    }  else    {    print("You are not close enough to any door!");    }  }  [ read buildingif (said("read", "building"))  {  print("The stage travel building has inscribed on its wall, \"Stage Travel.\"");  }  [ look street lampif (said("examine", "lamp"))  {  print("This light shines brightly when it is dark.");  }  [ ride stagecoach/get in stagecoachif ((said("ride", "coach") || said("enter", "coach")))  {  [ if already in the stagecoach  if ((StagecoachPhase == SC_TRAVELLING ||        StagecoachPhase > SC_TRAVELLING))    {    print("You are riding on a stage!");    }  else    {    print("You can't do that now!");    }  }  [ look stagecoachif (said("examine", "coach"))  {  [ if in the wagon, on way to Missouri  if ((StagecoachPhase == SC_TRAVELLING ||        StagecoachPhase > SC_TRAVELLING))    {    print("This is a nice-looking stage!");    }  else    {    print("You can't do that now!");    }  }  [ look store/look food store/look hardware storeif ((said("examine", "shop") ||     said("examine", "food", "shop") ||     said("examine", "food") ||     said("examine", "hardware", "shop") ||     said("examine", "hardware")))  {  print("The grocery and hardware stores are not far away.");  }  [ look liveryif ((said("examine", "livery") ||     said("examine", "livery", "building")))  {  print("The livery is close by.");  }  Done:return();[ **************************************[ MESSAGES[ **************************************#message 1 "This is your boss. He's the number one man at the Brooklyn Evening Star."#message 2 "This young man works at the grocery store."#message 3 "This short man works at the livery."#message 4 "The short man says, \"Hi, Jerrod. Stop by the livery sometime.\""#message 5 "This man and wagon are flying down Fulton Street!"#message 6 "There is no one around."#message 7 "There is no one close enough."#message 8 "The young man says, \"Have a nice day, Jerrod!\""#message 9 "Your boss, as usual, says, \"Keep up the good work, Jerrod.\""#message 10 "The man on the wagon cannot hear you over the rumble of the wagon."#message 11 "You see the stage travel building, the grocery store, the hardware store and a portion of the livery."#message 12 "This is where Water Street and Fulton Street intersect."#message 13 "There is no wagon here."#message 14 "That is a smooth-running team!"#message 15 "You are outside the \"Stage Travel\" building."#message 16 "You notice nothing unusual about the door on the left, but there is a small note on the other door."#message 17 "To get a good look you need to be closer."#message 18 "The note says... "#message 19 " PLEASE USE OTHER DOOR "#message 20 "You are unable to open the door on the right."#message 21 "The stage travel building has inscribed on its wall, \"Stage Travel.\""#message 22 "You are not close enough to any door!"#message 24 "This light shines brightly when it is dark."#message 25 "You don't need the note."#message 26 "You are riding on a stage!"#message 27 "You can't do that now!"#message 28 "This is a nice-looking stage!"#message 29 "The grocery and hardware stores are not far away."#message 30 "The livery is close by."