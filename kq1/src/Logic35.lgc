#define a.dwarf o1#define dwarf.will.come f20#define dwarf.in.room   f21#define dwarf.leaving   f23#define survivable.fall f24#define stun.done f25#define deadly.fall f26#define fall.sound.done f28#define beanstalk.sound.done    f29#define dwarf.sound f30#define dwarf.sound.done    f31#define stunned.time    v30#define dwarf.step      v31if (newRoom)  {  load.pic(currentRoom);  draw.pic(currentRoom);  discard.pic(currentRoom);  set.horizon(44);  load.sound(Sound4);  load.sound(s.ego.fall);  if (goat.following)    {    load.logics(lgc.goat);    }  if (dead.goat.room == currentRoom)    {    add.to.pic(View62, 0, 0, 24, 110, 0, 0);    }  if ((have.beans ||       beanstalk.room == 35))    {    beanstalk.overlay = 84;    set(can.plant.beanstalk);    load.pic(beanstalk.overlay);    load.view(View114);    load.view(View103);    load.view(View104);    load.view(View74);    load.view(View105);    load.logics(lgc.beanstalk);    load.sound(Sound12);    }  if (previousRoom == 70 &&       climbing.beanstalk)    {    set.view(ego, View74);    position(ego, 64, 41);    move.obj(ego, 64, 41, 0, done);    set.priority(ego, 8);    }  if (previousRoom == 70 &&       falling.from.sky)    {    program.control();    ignore.horizon(ego);    set.priority(ego, 15);    set.view(ego, View105);    get.posn(ego, temp.x, temp.y);    if (temp.x > 75)      {      position(ego, 80, 29);      }    else      {      position(ego, 65, 29);      }    get.posn(ego, temp.x, temp.y);    temp.y = 106;    temp.step = 2;    move.obj.v(ego, temp.x, temp.y, temp.step, deadly.fall);    }  random(0, 250, work);  if (work < 85)    {    dwarf.step = 4;    step.size(a.dwarf, dwarf.step);    load.view(View111);    animate.obj(a.dwarf);    set.view(a.dwarf, View111);    set(dwarf.will.come);    load.sound(m.badguy);    load.sound(Sound16);    }  if (dwarf.will.come)    {Label1:    random(0, 250, work.2);    if (work.2 > 90)      {      goto(Label1);      }    }  if (beanstalk.room == 35)    {    overlay.pic(beanstalk.overlay);    }  draw(ego);  show.pic();  }if (dwarf.in.room && sound.done)  {  if (!dwarf.sound)    {    set(dwarf.sound);    sound(Sound16, dwarf.sound.done);    }  if (dwarf.sound.done)    {    reset(dwarf.sound);    reset(dwarf.sound.done);    }  }if (falling.from.sky && !isset(lf7))  {  set(lf7);  set(ego.stunned);  sound(s.ego.fall, fall.sound.done);  }if (deadly.fall)  {  stop.sound();  set(lf7);  reset(falling.from.sky);  reset(ego.stunned);  set.view(ego, View114);  shake.screen(2);  set(certain.death);  }--work.2;if (work.2 == 1 &&     !falling.from.sky && !climbing.beanstalk)  {  position(a.dwarf, 16, 79);  set(dwarf.in.room);  sound(m.badguy, sound.done);  draw(a.dwarf);  if (!goat.following)    {    print("There is a small dwarf close by.  It would be a good idea to be "          "careful.");    follow.ego(a.dwarf, 7, menace.caught.ego);    }  if (isset(goat.following))    {    wander(a.dwarf);    set(dwarf.leaving);    print("There is a small dwarf close by.  It would be a good idea to be "          "careful.");    print("The dwarf sees the goat and decides to leave.");    }  }if (!dwarf.in.room)  {  if (said("anyword", "dwarf"))    {    print("There is no dwarf here.");    }  }if (dwarf.in.room)  {  if (said("check", "dwarf"))    {    print("Dwarfs are quick, little guys who will try to take your treasure.");    }  if (said("kill", "dwarf"))    {    print("He's too quick for you to catch.");    }  if ((said("speak", "dwarf") ||       said("hello") ||       said("say", "hello") ||       said("hello", "dwarf")))    {    print("No time to talk to him.  He's in too much of a hurry!");    }  }if (menace.caught.ego)  {  reset(menace.caught.ego);  if (isset(protected.spell))    {    print("It's a good thing you are protected by a spell.  That little dwarf "          "likes to steal treasures.");    wander(a.dwarf);    set(dwarf.leaving);    }  else    {    if (ego.invisible)      {      print("Being invisible has protected you from the dwarf.");      wander(a.dwarf);      set(dwarf.leaving);      }    else      {      if (have.mirror)        {        reset(have.mirror);        set(lost.mirror);        currentScore -= 8;        drop("magic mirror");        set(failed.quest);        reset(castle.locked);        --num.treasures;        }      else        {        if (have.shield)          {          reset(have.shield);          set(lost.shield);          currentScore -= 8;          drop("shield");          set(failed.quest);          reset(castle.locked);          --num.treasures;          }        else          {          if (have.chest)            {            reset(have.chest);            set(lost.chest);            currentScore -= 8;            drop("chest");            set(failed.quest);            reset(castle.locked);            --num.treasures;            }          else            {            if (have.diamonds)              {              reset(have.diamonds);              set(lost.diamonds);              currentScore -= 6;              drop("pouch of diamonds");              }            else              {              if (have.opened.walnut)                {                reset(have.opened.walnut);                set(lost.walnut);                currentScore -= 6;                drop("gold walnut");                }              else                {                if (have.egg)                  {                  reset(have.egg);                  set(lost.egg);                  currentScore -= 6;                  drop("gold egg");                  }                else                  {                  if (have.pouch)                    {                    reset(have.pouch);                    set(lost.pouch);                    currentScore -= 3;                    drop("pouch");                    }                  else                    {                    if (have.sceptre)                      {                      reset(have.sceptre);                      set(lost.sceptre);                      currentScore -= 6;                      drop("sceptre");                      }                    else                      {                      print("The quick, little dwarf came by to see what you "                            "had -- nothing interested him.");                      wander(a.dwarf);                      set(dwarf.leaving);                      goto(Label2);                      }                    }                  }                }              }            }          }        }      print("That little dwarf caught you by surprise.  Is your treasure still "            "OK?");      wander(a.dwarf);      set(dwarf.leaving);      }    }  }Label2:if (dwarf.leaving &&     edgeObjHit != NOT_HIT)  {  erase(a.dwarf);  reset(dwarf.leaving);  reset(dwarf.in.room);  }if (have.beans && can.plant.beanstalk)  {  if (said("bury", "bean"))    {    reset(have.beans);    beanstalk.room = 35;    set(planted.beans);    drop("beans");    currentScore  += 2;    print("The beans immediately sprout roots that reach deep into the fertile "          "soil... leaves unfold themselves to the warm, loving sun... a "          "rumbling is felt... and a mighty beanstalk now stretches up into the "          "sky!");    sound(Sound12, beanstalk.sound.done);    overlay.pic(beanstalk.overlay);    show.pic();    }  }if (beanstalk.room == 35 && !ego.invisible)  {  if (said("climb", "beanstalk") &&       !climbing.beanstalk)    {    if (posn(ego, 52, 76, 103, 97))      {      erase(ego);      ignore.blocks(ego);      set.view(ego, View74);      set(climbing.beanstalk);      position(ego, 71, 77);      set.priority(ego, 8);      draw(ego);      move.obj(ego, 71, 77, 0, done);      }    else      {      print("You can't reach the beanstalk from here.");      }    }  }if (beanstalk.room != 35)  {  if (said("climb", "beanstalk"))    {    print("There is no beanstalk here to climb.");    }  }if (climbing.beanstalk)  {  if (isset(egoHitSpecial) &&       posn(ego, 60, 78, 93, 80))    {    erase(ego);    set.view(ego, View0);    observe.blocks(ego);    reset(climbing.beanstalk);    position(ego, 70, 106);    release.priority(ego);    draw(ego);    }  if (egoHitSpecial &&       !posn(ego, 60, 78, 93, 80))    {    program.control();    set.priority(ego, 15);    get.posn(ego, temp.x, temp.y);    erase(ego);    set.view(ego, View105);    reset(climbing.beanstalk);    position.v(ego, temp.x, temp.y);    draw(ego);    temp.y = 106;    temp.step = 2;    move.obj.v(ego, temp.x, temp.y, temp.step, survivable.fall);    set(ego.stunned);    sound(s.ego.fall, fall.sound.done);    }  }--stunned.time;if (survivable.fall)  {  stop.sound();  reset(survivable.fall);  observe.blocks(ego);  release.priority(ego);  stop.motion(ego);  set.view(ego, View103);  stunned.time = 20;  set(keep.cycling);  shake.screen(2);  print("Ouch!");  set(ego.stunned);  sound(Sound4, sound.done);  }if (sound.done)  {  if (stunned.time > 0)    {    reset(sound.done);    sound(Sound4, sound.done);    }  }if (stunned.time == 1)  {  set.view(ego, View104);  end.of.loop(ego, stun.done);  }if (stun.done)  {  reset(stun.done);  reset(keep.cycling);  start.motion(ego);  set.view(ego, View0);  release.priority(ego);  player.control();  }if (edgeEgoHit != NOT_HIT)  {  reset(can.plant.beanstalk);  }if (edgeEgoHit == TOP_EDGE &&     climbing.beanstalk)  {  new.room(Logic70);  }if (edgeEgoHit == TOP_EDGE &&     !climbing.beanstalk)  {  new.room(Logic46);  }if (edgeEgoHit == RIGHT_EDGE)  {  new.room(Logic34);  }if (edgeEgoHit == LEFT_EDGE)  {  new.room(Logic36);  }if (edgeEgoHit == BOTTOM_EDGE)  {  new.room(Logic30);  }if (goat.following)  {  call(lgc.goat);  }if (beanstalk.room == 35)  {  call(lgc.beanstalk);  }return();[ Messages#message 1 "There is a small dwarf close by.  It would be a good idea to be careful."#message 2 "That little dwarf caught you by surprise.  Is your treasure still OK?"#message 3 "The quick, little dwarf came by to see what you had -- nothing interested him."#message 4 "Dwarfs are quick, little guys who will try to take your treasure."#message 5 "There is no dwarf here."#message 6 "He's too quick for you to catch."#message 7 "No time to talk to him.  He's in too much of a hurry!"#message 8 "It's a good thing you are protected by a spell.  That little dwarf likes to steal treasures."#message 9 "The beans immediately sprout roots that reach deep into the fertile soil... leaves unfold themselves to the warm, loving sun... a rumbling is felt... and a mighty beanstalk now stretches up into the sky!"#message 10 "You can't reach the beanstalk from here."#message 11 "There is no beanstalk here to climb."#message 12 "Ouch!"#message 13 "The dwarf sees the goat and decides to leave."#message 14 "Being invisible has protected you from the dwarf."